<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DIDIM — Zamówienie</title>
  <link rel="icon" href="./assets/img/brand/logo.png" type="image/png" />
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <script defer src="./assets/js/brand.js"></script>
  <script defer src="./assets/js/script.js"></script>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="topbar">
      <a class="brand" href="./index.html">
        <img id="brand-logo" src="./assets/img/brand/logo.png" alt="Logo">
        <strong>DIDIM</strong>
      </a>
      <button class="cart-btn" onclick="location.href='./order.html'">
        Koszyk <span class="cart-count">0</span>
      </button>
    </div>

    <nav class="links">
      <a href="./index.html">Start</a>
      <a href="./menu.html">Menu</a>
      <a href="./order.html" aria-current="page">Zamówienie</a>
      <a href="./contact.html">Kontakt</a>
      <a href="./regulamin.html">Regulamin</a>
      <a href="./privacy.html">Prywatność</a>
    </nav>
  </div>
</header>

<section class="section">
  <div class="container">
    <h1>Twoje zamówienie</h1>

    <div class="grid grid-2">
      <!-- LEWA KOLUMNA -->
      <div class="card">
        <h3>Dane klienta</h3>

        <label>Imię i nazwisko
          <input id="name" placeholder="Jan Kowalski">
        </label>

        <label>Telefon
          <input id="phone" placeholder="+48 600 000 000">
        </label>

        <label><input type="checkbox" id="pickup"> Odbiór osobisty</label>

        <div id="addr">
          <label>Ulica i nr
            <input id="street" placeholder="Przykładowa 10/2">
          </label>

          <label>Kod pocztowy
            <input id="zip" placeholder="00-000">
          </label>

          <label>Miasto
            <input id="city" placeholder="Warszawa">
          </label>
        </div>
      </div>

      <!-- PRAWA KOLUMNA -->
      <div class="card">
        <h3>Podsumowanie</h3>

        <table class="table">
          <thead>
            <tr>
              <th>Produkt</th>
              <th>Cena</th>
              <th>Ilość</th>
              <th>Suma</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="order-items"></tbody>
        </table>

        <div style="margin-top:10px">
          <label>Sposób realizacji
            <select id="deliveryMethod">
              <option value="pickup">Odbiór osobisty</option>
              <option value="delivery">Dostawa (+6 PLN)</option>
            </select>
          </label>
        </div>

        <div class="totals">
          <div>Razem: <strong id="sum-subtotal">0,00 PLN</strong></div>
          <div>Dostawa: <strong id="sum-delivery">0,00 PLN</strong></div>
          <div>Do zapłaty: <strong id="sum-total">0,00 PLN</strong></div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="payNow" class="cta">Zamów i zapłać</button>
          <button id="clearCart" class="cta">Wyczyść koszyk</button>
        </div>

        <p class="kicker">Zamówienia wyłącznie z płatnością online (Stripe).</p>
      </div>
    </div>
  </div>
</section>

<footer class="footer">
  <div class="container">
    <div class="kicker">© 2025 DIDIM • <a href="./privacy.html">Prywatność</a> • <a href="./regulamin.html">Regulamin</a></div>
  </div>
</footer>

<script>
(function(){
  const byId = id => document.getElementById(id);
  const $items = byId('order-items');
  const $count = document.querySelector('.cart-count');
  const DELIVERY_FEE = 600; // grosze = 6,00 PLN

  let cart = [];

  function loadCart(){
    try { cart = JSON.parse(localStorage.getItem('cart') || '[]'); }
    catch(e){ cart = []; }
    updateCount();
  }

  function updateCount(){
    $count.textContent = cart.reduce((s,i)=>s+Number(i.qty||0),0);
  }

  function formatPLN(grosze){
    return (grosze/100).toFixed(2).replace('.', ',') + ' PLN';
  }

  function rowSum(item){
    return Math.round(Number(item.price)*100) * Number(item.qty);
  }

  function subtotal(){
    return cart.reduce((s,it)=>s + rowSum(it), 0);
  }

  function recalc(){
    const sub = subtotal();
    const delivery = byId('deliveryMethod').value === 'delivery' ? DELIVERY_FEE : 0;
    byId('sum-subtotal').textContent = formatPLN(sub);
    byId('sum-delivery').textContent = formatPLN(delivery);
    byId('sum-total').textContent = formatPLN(sub + delivery);
  }

  function render(){
    $items.innerHTML = '';
    cart.forEach((it,idx) => {
      const tr = document.createElement('tr');
      const unit = Math.round(Number(it.price)*100);
      tr.innerHTML = `
        <td>${it.name}</td>
        <td>${formatPLN(unit)}</td>
        <td>
          <div class="qty">
            <button class="qty-dec" data-idx="${idx}" aria-label="Zmniejsz">−</button>
            <span class="qty-val">${it.qty}</span>
            <button class="qty-inc" data-idx="${idx}" aria-label="Zwiększ">+</button>
          </div>
        </td>
        <td>${formatPLN(rowSum(it))}</td>
        <td><button class="remove" data-idx="${idx}" aria-label="Usuń pozycję">✕</button></td>
      `;
      $items.appendChild(tr);
    });
    recalc();
  }

  // Events
  document.addEventListener('click', (e)=>{
    if (e.target.classList.contains('qty-inc')){
      const i = Number(e.target.dataset.idx);
      cart[i].qty = Number(cart[i].qty||1) + 1;
      localStorage.setItem('cart', JSON.stringify(cart));
      render(); updateCount();
    }
    if (e.target.classList.contains('qty-dec')){
      const i = Number(e.target.dataset.idx);
      cart[i].qty = Math.max(1, Number(cart[i].qty||1) - 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      render(); updateCount();
    }
    if (e.target.classList.contains('remove')){
      const i = Number(e.target.dataset.idx);
      cart.splice(i,1);
      localStorage.setItem('cart', JSON.stringify(cart));
      render(); updateCount();
    }
  });

  document.addEventListener('change', (e)=>{
    if (e.target.id === 'deliveryMethod') recalc();
    if (e.target.id === 'pickup'){
      byId('addr').style.display = e.target.checked ? 'none' : 'block';
      if (e.target.checked) byId('deliveryMethod').value = 'pickup';
      recalc();
    }
  });

  byId('clearCart').addEventListener('click', ()=>{
    if (confirm('Wyczyścić koszyk?')){
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      render(); updateCount();
    }
  });

  byId('payNow').addEventListener('click', async ()=>{
    const name = byId('name').value.trim();
    const phone = byId('phone').value.trim();
    if (!name || !phone){
      alert('Uzupełnij imię i telefon.');
      return;
    }
    if (cart.length === 0){
      alert('Koszyk jest pusty.');
      return;
    }
    const total = subtotal() + (byId('deliveryMethod').value === 'delivery' ? DELIVERY_FEE : 0); // grosze

    try{
      const body = new URLSearchParams({ amount: String(total) });
      const res = await fetch('/api/stripe/create_checkout.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      const data = await res.json();
      if (data.url){
        window.location.href = data.url; // Stripe Checkout
      }else{
        alert('Błąd płatności. Spróbuj ponownie.');
        console.error(data);
      }
    }catch(err){
      alert('Nie udało się zainicjować płatności.');
      console.error(err);
    }
  });

  // init
  loadCart();
  render();
  const cb = document.getElementById('pickup'), addr = document.getElementById('addr');
  const toggle = ()=>{ addr.style.display = cb.checked ? 'none' : 'block'; };
  cb.onchange = toggle; toggle();
})();
</script>

</body>
</html>
